import Image from "next/image";
import Link from "next/link";
import { Callout, Tabs, Tab } from "nextra-theme-docs";
import { Prerequisites, Accordion, NextSteps } from "~components";

# Setup a Defer application

A Defer application is necessary to trigger background function executions from your application.

<p>&nbsp;</p>
<p>&nbsp;</p>

## Setup a new application or environment

<Accordion title={"Setup a new application"}>

First, sign in to the Defer Console:

<div style={{ display: "flex", margin: "20px 0" }}>
  <Link
    href={process.env.NEXT_PUBLIC_DASHBOARD_CREATE_APP || ""}
    className={"button-primary"}
  >
    <div>
      <svg
        width="40"
        height="41"
        viewBox="0 0 40 41"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fillRule="evenodd"
          clipRule="evenodd"
          d="M40 0.5V40.5H0V0.5H40ZM15.7143 4.78571H4.28571V16.2143H15.7143V4.78571ZM4.28571 20.5H20V4.78571H25.7143V26.2143H4.28571V20.5ZM4.28571 36.2143V30.5H30V4.78571H35.7143V36.2143H4.28571Z"
          fill="black"
        />
      </svg>
      <div>Setup an application on Defer</div>
    </div>
  </Link>
</div>

On the create application form, make sure to install Defer on your GitHub account or organization so Defer can list your repositories.

<div className={"image"}>
  <div>
    <Image
      src="/platform/get-a-token/install-defer-github.png"
      alt="Install Defer on your GitHub account"
      width={400}
      height={450}
    />
  </div>
</div>

Then, select the GitHub repository of your application:

<div className={"image"}>
  <div>
    <Image
      src="/platform/get-a-token/choose-repo.png"
      alt="Select a GitHub repository"
      width={400}
      height={450}
    />
  </div>
</div>

</Accordion>

<Accordion title={"Setup a new environment"}>

Defer allows each application to have multiple environments.

Each environment is tied to a GitHub branch, making it easy to test new features before moving to production.

First, sign in to the Defer Console:

<div style={{ display: "flex", margin: "20px 0" }}>
  <Link
    href={process.env.NEXT_PUBLIC_API_SIGNIN || ""}
    className={"button-primary"}
  >
    <div>
      <svg
        width="40"
        height="41"
        viewBox="0 0 40 41"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fillRule="evenodd"
          clipRule="evenodd"
          d="M40 0.5V40.5H0V0.5H40ZM15.7143 4.78571H4.28571V16.2143H15.7143V4.78571ZM4.28571 20.5H20V4.78571H25.7143V26.2143H4.28571V20.5ZM4.28571 36.2143V30.5H30V4.78571H35.7143V36.2143H4.28571Z"
          fill="black"
        />
      </svg>
      <div>Sign-in to the Defer Console</div>
    </div>
  </Link>
</div>

To create a new environment, go to the Defer Console's home and, on an application card, open the actions menu:

<div className={"image"}>
  <div>
    <Image
      src="/platform/get-a-token/add-new-environment.png"
      alt="Create a new environment"
      width={400}
      height={450}
    />
  </div>
</div>

You will land on the application form with the application's repository preselected:

<div className={"image"}>
  <div>
    <Image
      src="/platform/get-a-token/new-environment.png"
      alt="New environment form"
      width={400}
      height={450}
    />
  </div>
</div>

Provide a valid branch name and environment name.

</Accordion>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

## Environment variables

The background functions that run in Defer might need to access some externally configured services or databases. For this reason, we recommend using the **same environment variables configuration** for your target API environment and Defer application.

<Callout type={"info"}>
**Tips**

**Got a `.env` file?** Copy the file's content into your clipboard and paste it into the first field of the "Add" line. ✨

</Callout>

<p>&nbsp;</p>
<p>&nbsp;</p>

### Doppler beta support

Defer supports syncing your environment variables from [Doppler](https://www.doppler.com/) (read-only).

To enable Doppler for a given environment, create a Doppler Service Token, as shown below:

<div className={"image"}>
  <div>
    <Image
      src="/platform/get-a-token/doppler-service-token.png"
      alt="Pre-build command"
      width={700}
      height={450}
    />
  </div>
</div>

Then, set a `DOPPLER_TOKEN` environment variable with a dedicated Doppler Service Token.

<div className={"image"}>
  <div>
    <Image
      src="/platform/get-a-token/doppler-token-defer.png"
      alt="Pre-build command"
      width={600}
      height={450}
    />
  </div>
</div>

Each Build and Execution will get access to the environment variables provided by your Doppler token.

<p>&nbsp;</p>

<Callout type="info">

The current beta Doppler support has the following limitations:

- a change on Doppler's side will only affect new builds and executions
- a one-way sync is Doppler → Defer is performed; we don't copy your environment's `DEFER_TOKEN` on Doppler.

</Callout>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

## Monorepo, Prisma

If your application resides in a mono repo or relies on Prisma, please refer to the [Builds](/platform/builds) page on advanced options.

<div className={"image"}>
  <div>
    <Image
      src="/platform/get-a-token/pre-build-command.png"
      alt="Pre-build command"
      width={400}
      height={450}
    />
  </div>
</div>

<p>&nbsp;</p>
<p>&nbsp;</p>

Once your application is properly configured, click the “Create” button.

Once redirected to the application, you should now get a Defer Token as follows:

<div className={"image"}>
  <div>
    <Image
      src="/platform/get-a-token/copy-token.png"
      alt="Copy your Defer token"
      width={800}
      height={900}
    />
  </div>
</div>

<p>&nbsp;</p>
<p>&nbsp;</p>
